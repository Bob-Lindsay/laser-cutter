#!/usr/bin/env ruby
require 'laser-cutter'
require 'optparse'
require 'colored'
require 'json'
require 'hashie/mash'

module Laser
  module Cutter
    class OptParse
      def self.parse(args)
        banner_text = <<-EOF
Usage: laser-cutter [options]'

Examples:
  1. Create a box defined in inches, and open PDF in preview right after:

       laser-cutter --units in -s 3x2x2/0.125/0.5  -O -o box.pdf

  2. Create a box defined in millimeters, print verbose info and set
     page size to A3, and layout to landscape, and stroke width to 2mm:

       laser-cutter -w70 -h20 -d50 -t4.3 -n5 -PA3 -L landscape -S 0.5 -v -O -o box.pdf
EOF

        options = Hashie::Mash.new
        options.verbose = false

        opt_parser = OptionParser.new do |opts|
          opts.banner = banner_text.cyan
          opts.separator ""
          opts.separator "Specific options:"

          opts.on("-s", "--size WxHxD/T/N",
              "Combined internal dimensions: W = width, H = height,\n#{" " * 37}D = depth, T = thickness, N = notch length\n\n") do |size|
            options.size = size
          end

          opts.on("-w", "--width WIDTH", "Internal width of the box") { |value|  options.width = value }
          opts.on("-h", "--height HEIGHT", "Internal height of the box") { |value|  options.height = value }
          opts.on("-d", "--depth DEPTH", "Internal depth of the box") { |value|  options.depth= value }

          opts.on("-t", "--thickness THICKNESS", "Thickness of the box material") { |value|  options.thickness = value }
          opts.on("-n", "--notch NOTCH", "Preferred notch length (used only as a guide)") { |value|  options.notch = value }
          opts.on("-o", "--file FILE", "Output filename of the PDF") { |value|  options.file = value }

          opts.on("-u", "--units UNITS", "Either 'mm' (default) or 'in'") { |value|  options.units = value }
          opts.on("-m", "--margin MARGIN", "Margins from the edge of the document") { |value|  options.margin = value }
          opts.on("-p", "--padding PADDING", "Space between the boxes on the page") { |value|  options.padding = value }

          opts.on("-P", "--page_size LETTER", "Page size, see docs on Prawn for more options") { |value|  options.page_size = value }
          opts.on("-L", "--page_layout portrait", "Page layout, other option is 'landscape' ") { |value|  options.page_layout = value }
          opts.on("-S", "--stroke WIDTH", "Numeric stroke width of the line") { |value|  options.stroke = value }

          opts.on("-O", "--open", "Open generated file with system viewer before exiting") { |v| options.open = v }
          opts.on("-v", "--[no-]verbose", "Run verbosely") { |v| options.verbose = v }

          opts.separator ""
          opts.separator "Common options:"

          opts.on_tail("--help", "Show this message") do
            puts opts
            exit
          end
          opts.on_tail("--version", "Show version") do
            puts Laser::Cutter::VERSION
            exit
          end
        end
        opt_parser.parse!(args)
        options
      rescue OptionParser::InvalidOption, OptionParser::MissingArgument => e
        puts opt_parser.help
        puts
        puts "#{e.message}".red
        exit 1
      end # end parse()
    end
  end
end # class OptParse

options = Laser::Cutter::OptParse.parse(ARGV)
config = Laser::Cutter::Configuration.new(options.to_hash)

if options.verbose
  puts "Starting with the following configuration:"
  puts JSON.pretty_generate(config.to_hash).green
end

begin
  config.validate!
rescue Exception => e
  STDERR.puts "\nSorry, #{e}".red
  STDERR.puts "Try --help for more info..."
  exit 1
end

begin
  box = Laser::Cutter::Box.new(config)
  Laser::Cutter::Renderer::BoxRenderer.new(box, config).render
  if config.open
    `open #{config.file}`
  end
rescue Exception => e
  puts "#{e}".red
  STDERR.puts "Try --help for more info...".yellow
  if options.verbose
    STDERR.puts "Exception: #{e.inspect}".red
    STDERR.puts e.backtrace.join("\n").red
  end
end


